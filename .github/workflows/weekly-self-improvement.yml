name: Weekly Self-Improvement

# Run every Monday at 9am UTC
on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggers

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  self-improve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for better context

      - name: Run Claude Code for Maintenance
        uses: anthropics/claude-code-action@v1
        with:
          # Maintenance tasks focusing on code quality and bug fixes
          prompt: |
            Perform weekly maintenance on this VGGT-MPS (3D Vision Agent) repository:

            **Primary Goals:**
            1. Code Quality & Best Practices
               - Review Python code for PEP 8 compliance and type hints
               - Check for potential bugs or error handling improvements
               - Identify deprecated dependencies or API usage
               - Look for opportunities to improve code clarity

            2. Documentation
               - Update README.md if features have changed
               - Ensure code comments are accurate and helpful
               - Check if examples in docs/ match current API
               - Verify setup instructions are up-to-date

            3. Testing & Dependencies
               - Check requirements.txt and pyproject.toml for outdated packages
               - Suggest test coverage improvements
               - Review GitHub Actions workflows for optimization

            4. Small Enhancements
               - Identify quick wins for better user experience
               - Suggest performance optimizations (especially for MPS)
               - Look for opportunities to reduce code duplication

            **Constraints:**
            - Focus on small, incremental improvements
            - Do NOT make breaking changes
            - Prioritize maintainability over new features
            - Test any changes if possible

            **Output:**
            - Create a PR with your improvements
            - Use clear commit messages explaining each change
            - Add a summary of what was improved and why

          # Create a PR automatically
          create_pr: true

          # PR configuration
          pr_title: "Weekly Self-Improvement: Automated Maintenance"
          pr_body: |
            ðŸ¤– **Automated Weekly Maintenance**

            This PR was automatically generated by the Claude Code GitHub Action as part of our weekly self-improvement workflow.

            ## Changes Made
            Claude has analyzed the codebase and made the following improvements:

            - Code quality enhancements
            - Documentation updates
            - Potential bug fixes
            - Dependency updates (if needed)

            ## Review Checklist
            - [ ] All changes are backward compatible
            - [ ] Tests pass (if modified)
            - [ ] Documentation is accurate
            - [ ] No security concerns introduced

            ## Next Steps
            Please review the changes and merge if appropriate. You can also request modifications or close the PR if the changes aren't needed this week.

            ---
            *Generated on: ${{ github.run_id }}*
            *Workflow: `weekly-self-improvement.yml`*

          # Branch to create PR from
          branch_prefix: "auto-improve"

          # Base branch to PR against (develop per contributing guidelines)
          base_branch: "develop"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Weekly self-improvement workflow failed. Check the logs for details."
          echo "This may indicate issues with the repository structure or the action configuration."
