name: Weekly Self-Improvement

# Run every Monday at 9am UTC
on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggers

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  self-improve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for better context

      - name: Run Claude Code for Maintenance
        uses: anthropics/claude-code-action@v1
        with:
          # Maintenance tasks focusing on code quality and bug fixes
          prompt: |
            Perform weekly maintenance on this VGGT-MPS (3D Vision Agent) repository.

            **IMPORTANT: Read CLAUDE.md first!**
            This file contains the guardrails for what changes you can and cannot make.
            Follow these constraints strictly.

            **Primary Goals:**
            1. Documentation (see CLAUDE.md for allowed changes)
               - Update README.md for accuracy and clarity
               - Fix typos and improve docstrings
               - Ensure examples match current API
               - Verify setup instructions are up-to-date

            2. CI/CD and Metadata (see CLAUDE.md for allowed changes)
               - Improve GitHub Actions workflows
               - Update metadata in pyproject.toml
               - Optimize automation

            3. Code Quality - Non-Functional Only (see CLAUDE.md for allowed changes)
               - Add type hints and docstrings
               - Format code to PEP 8 standards
               - Improve variable naming
               - Add code comments for clarity

            **Constraints:**
            - MUST follow all guardrails in CLAUDE.md
            - Focus on docs, CI, and metadata ONLY
            - NO changes to core functionality
            - NO dependency changes
            - NO breaking changes
            - Small, incremental improvements only

            **Output:**
            - Create a PR with your improvements
            - Use clear commit messages explaining each change
            - Reference CLAUDE.md compliance in PR description

          # Create a PR automatically
          create_pr: true

          # PR configuration
          pr_title: "Weekly Self-Improvement: Automated Maintenance"
          pr_body: |
            ðŸ¤– **Automated Weekly Maintenance**

            This PR was automatically generated by the Claude Code GitHub Action as part of our weekly self-improvement workflow.

            ## Changes Made
            Claude has analyzed the codebase and made the following improvements:

            - Code quality enhancements
            - Documentation updates
            - Potential bug fixes
            - Dependency updates (if needed)

            ## Review Checklist
            - [ ] All changes are backward compatible
            - [ ] Tests pass (if modified)
            - [ ] Documentation is accurate
            - [ ] No security concerns introduced

            ## Next Steps
            Please review the changes and merge if appropriate. You can also request modifications or close the PR if the changes aren't needed this week.

            ## Guardrails
            All changes comply with [CLAUDE.md](../CLAUDE.md) guardrails.

            ---
            *Generated on: ${{ github.run_id }}*
            *Workflow: `self-improve.yml`*

          # Branch to create PR from
          branch_prefix: "auto-improve"

          # Base branch to PR against (develop per contributing guidelines)
          base_branch: "develop"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Weekly self-improvement workflow failed. Check the logs for details."
          echo "This may indicate issues with the repository structure or the action configuration."
